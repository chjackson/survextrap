<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation-based calibration of survextrap • survextrap</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Simulation-based calibration of survextrap">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a></li>
    <li><a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a></li>
    <li><a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a></li>
    <li><a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation-based calibration of survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2026-01-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/sbc.Rmd" class="external-link"><code>vignettes/sbc.Rmd</code></a></small>
      <div class="d-none name"><code>sbc.Rmd</code></div>
    </div>

    
    
<p><span class="math display">\[
\def\x{{\boldsymbol{x}}}
\def\y{{\boldsymbol{y}}}
\]</span></p>
<p>As described in Talts et al. 2018, “Validating Bayesian Inference
Algorithms with Simulation-Based Calibration”, see <a href="https://mc-stan.org/docs/stan-users-guide/simulation-based-calibration.html" class="external-link">the
Stan manual</a>.</p>
<p>“Validating” here means checking a combination of:</p>
<ol style="list-style-type: decimal">
<li><p>the algorithm has been coded correctly.</p></li>
<li><p>the algorithm samples from the correct posterior (e.g. MCMC has
converged)</p></li>
</ol>
<p>Here we want to test that the <code>survextrap</code> package (which
calls the Stan software for Bayesian estimation) samples from the
posterior that it is supposed to sample from.</p>
<div class="section level2">
<h2 id="core-principle">Core principle<a class="anchor" aria-label="anchor" href="#core-principle"></a>
</h2>
<p>The posterior <span class="math inline">\(p(\theta | \y)\)</span>,
integrated over data <span class="math inline">\(\y\)</span> generated
from the prior predictive distribution <span class="math inline">\(p(\y)\)</span>, is equivalent to the prior <span class="math inline">\(p(\theta)\)</span>.</p>
</div>
<div class="section level2">
<h2 id="core-approach-to-algorithm">Core approach to algorithm<a class="anchor" aria-label="anchor" href="#core-approach-to-algorithm"></a>
</h2>
<ul>
<li>
<p>Repeatedly do:</p>
<ol style="list-style-type: decimal">
<li><p>Simulate a dataset from the prior predictive distribution,
i.e. simulate <span class="math inline">\(\theta\)</span> from the prior
<span class="math inline">\(p(\theta)\)</span> followed by data <span class="math inline">\(y\)</span> from <span class="math inline">\(p(y|\theta)\)</span>.</p></li>
<li><p>Fit the model to this dataset, getting a posterior</p></li>
</ol>
</li>
<li><p>Average the resulting posteriors: should end up with the prior
you started with</p></li>
<li><p>If it doesn’t match: this is evidence of bug in code, or a
poorly-performing fitting algorithm.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="how-is-this-actually-done">How is this actually done<a class="anchor" aria-label="anchor" href="#how-is-this-actually-done"></a>
</h2>
<ul>
<li><p>Choose some quantity of interest from model <span class="math inline">\(h(\theta)\)</span> (<strong>scalar</strong>
parameter or function of parameters).</p></li>
<li>
<p>For each <span class="math inline">\(i = 1, \ldots,
N\)</span></p>
<ul>
<li><p>generate a value <span class="math inline">\(\tilde\theta_i\)</span> from the prior, hence a
dataset <span class="math inline">\(\tilde{\y}_i\)</span></p></li>
<li><p>generate a sample of size <span class="math inline">\(L\)</span>,
<span class="math inline">\(\{h(\theta_1), \ldots,
h(\theta_L)\}\)</span>, from the posterior <span class="math inline">\(h(\theta | \tilde{\y}_i)\)</span></p></li>
<li><p>compute the <strong>rank</strong> <span class="math inline">\(r_i\)</span> of <span class="math inline">\(h(\tilde\theta_i)\)</span> among <span class="math inline">\(\{h(\theta_1), \ldots,
h(\theta_L)\}\)</span></p></li>
</ul>
</li>
<li><p>Plot a histogram of the ranks <span class="math inline">\(r_1,\ldots,r_N\)</span>. They should be
<strong>uniformly distributed</strong> across <span class="math inline">\(0\)</span> to <span class="math inline">\(L\)</span>. <small>(proof in Talts et
al.)</small></p></li>
</ul>
</div>
<div class="section level2">
<h2 id="awkward-aspects">Awkward aspects<a class="anchor" aria-label="anchor" href="#awkward-aspects"></a>
</h2>
<p>Computationally expensive, though easily parallelisable</p>
<ul>
<li><small><span class="math inline">\(L=100\)</span> posterior sample
used in Talts et al. Prior samples <span class="math inline">\(N\)</span> chosen depending on speed of posterior
sampling, so that procedure takes a few hours at most. <span class="math inline">\(N=1000, 10000\)</span> used in Talts et
al.</small></li>
</ul>
<p>Have to check one parameter / quantity <span class="math inline">\(h(\theta)\)</span> a time</p>
<p>Informal check by eye: no quantitative measure of bad fit, so can’t
automate</p>
<p>Needs <strong>informative priors</strong> (enough to avoid extreme
samples from prior predictive distribution)</p>
</div>
<div class="section level2">
<h2 id="application-to-survextrap">Application to survextrap<a class="anchor" aria-label="anchor" href="#application-to-survextrap"></a>
</h2>
<p>Compare accuracy of posterior computation using three alternative
posterior sampling methods in Stan</p>
<ol style="list-style-type: lower-alpha">
<li><p>Full Hamiltonian MCMC</p></li>
<li><p>Optimisation / Laplace approximation</p></li>
<li><p>Variational Bayes</p></li>
</ol>
<p>Quantity of interest <span class="math inline">\(h(\theta)\)</span>:
the <strong>restricted mean survival time</strong> over 5 years</p>
<p><span class="math inline">\(N=1000\)</span> prior samples and model
fits, <span class="math inline">\(L=100\)</span> posterior samples,
which takes a few hours.</p>
<p>The knot configuration is fixed, and <strong>informative
priors</strong> are used. These priors are all designed to be strong
enough to avoid extreme values. The computation overflowed with a vague
<span class="math inline">\(N(0,20)\)</span> prior on the baseline log
hazard scale, but it worked with <span class="math inline">\(N(0,1)\)</span>.</p>
<p>This is not designed to mimic any specific applied situation, since
the aim is to validate the the fitting algorithm samples from the
correct posterior, not that the posterior is appropriate for a
particular situation.</p>
<p>Sample a survival dataset from that hazard function, with fixed
design (sample size, censor time)</p>
</div>
<div class="section level2">
<h2 id="simulation-and-model-fitting-function">Simulation and model fitting function<a class="anchor" aria-label="anchor" href="#simulation-and-model-fitting-function"></a>
</h2>
<p>Uses the <code><a href="../reference/prior_pred.html">prior_pred()</a></code> function supplied with the package
which simulates from a prior predictive distribution. This is called
with <code>fix_prior=TRUE</code> here so we simulate a single value of
<span class="math inline">\(\theta\)</span> from the prior, followed by
a dataset of 200 observations given that single value. Data are censored
at 5 years</p>
<p>We use <code>survextrap</code> to fit a model to the simulated data,
using the same priors and spline knots that were used for the
simluation. There are no covariates in this example.</p>
<p>The function has one argument <code>i</code>, to enable parallel
computation (see below). Calling this function once does one iteration
<code>i</code> of the algorithm above.</p>
<p>The <code>findInterval</code> call is used to get the rank of <span class="math inline">\(h(\tilde\theta_i)\)</span>
(<code>summ_prior</code>) among the posterior sample for the <span class="math inline">\(\{h(\theta_1), \ldots, h(\theta_L)\}\)</span>
(<code>summ</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_rank</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>, <span class="va">fit_method</span><span class="op">=</span><span class="st">"opt"</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span> <span class="co"># have to do this to parallelise on Windows, inefficient</span></span>
<span>  <span class="va">L</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>  <span class="va">knots</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span>  <span class="va">censtime</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span>  <span class="va">iter</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">fit_method</span><span class="op">==</span><span class="st">"mcmc"</span><span class="op">)</span> <span class="fl">1000</span> <span class="kw">else</span> <span class="fl">2000</span></span>
<span>  <span class="va">simdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_pred.html">prior_pred</a></span><span class="op">(</span>n<span class="op">=</span><span class="fl">200</span>, censtime<span class="op">=</span><span class="va">censtime</span>, fix_prior<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                      mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span><span class="op">)</span>, </span>
<span>                      prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                      prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/rstan_options.html" class="external-link">rstan_options</a></span><span class="op">(</span>silent <span class="op">=</span> <span class="cn">TRUE</span>, open_progress<span class="op">=</span><span class="cn">FALSE</span>,show_messages<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">tryres</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">simdf</span>,</span>
<span>                                  fit_method<span class="op">=</span><span class="va">fit_method</span>,</span>
<span>                                  iter <span class="op">=</span> <span class="va">iter</span>, </span>
<span>                                  mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span><span class="op">)</span>,</span>
<span>                                  prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                  prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                                  loo <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                  open_progress <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                  refresh <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">tryres</span>, <span class="st">"try-error"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod</span>, t<span class="op">=</span><span class="va">censtime</span>, niter<span class="op">=</span><span class="va">L</span><span class="op">)</span>,<span class="st">"sample"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">simdf</span>, <span class="st">"prior"</span><span class="op">)</span></span>
<span>      <span class="va">summ_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Survmspline.html">rmst_survmspline</a></span><span class="op">(</span>t<span class="op">=</span><span class="va">censtime</span>, <span class="va">prior</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">prior</span><span class="op">$</span><span class="va">coefs</span>, <span class="va">knots</span><span class="op">)</span></span>
<span>      <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html" class="external-link">findInterval</a></span><span class="op">(</span><span class="va">summ_prior</span>, <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">summ</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="va">res</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>  <span class="va">res</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="mcmc-method">MCMC method<a class="anchor" aria-label="anchor" href="#mcmc-method"></a>
</h2>
<p>The algorithm is used here to evaluate the MCMC model fitting method.
We do a non-parallelised loop over <code>N</code>, but within each
<code>i</code>, 4 chains are run in parallel for MCMC.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span> <span class="co">#  194 sec for 10 -&gt; 6 hours for 1000 </span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/progress#readme" class="external-link">progress</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ranks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">pb</span> <span class="op">&lt;-</span> <span class="va"><a href="http://r-lib.github.io/progress/reference/progress_bar.html" class="external-link">progress_bar</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>total<span class="op">=</span><span class="va">N</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ranks</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">sim_rank</span><span class="op">(</span><span class="va">i</span>, fit_method<span class="op">=</span><span class="st">"mcmc"</span><span class="op">)</span></span>
<span>  <span class="va">pb</span><span class="op">$</span><span class="fu">tick</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">ranks_mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ranks</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ranks_mcmc</span>, file<span class="op">=</span><span class="st">"sbc_files/ranks_mcmc.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="optimisation-method">Optimisation method<a class="anchor" aria-label="anchor" href="#optimisation-method"></a>
</h2>
<p>The optimisation method is evaluated in a parallelised loop over
<code>N</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/doparallel" class="external-link">doParallel</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: foreach</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: iterators</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: parallel</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">no_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> </span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">no_cores</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'sim_rank'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ranks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span>cl<span class="op">=</span><span class="va">cl</span>, X<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, fun<span class="op">=</span><span class="va">sim_rank</span><span class="op">)</span></span>
<span><span class="va">ranks_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ranks</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ranks_opt</span>, file<span class="op">=</span><span class="st">"sbc_files/ranks_opt.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="variational-bayes">Variational Bayes<a class="anchor" aria-label="anchor" href="#variational-bayes"></a>
</h2>
<p>The variational Bayes method is evaluated in a parallelised loop over
<code>N</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">no_cores</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">'sim_rank'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ranks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span>cl<span class="op">=</span><span class="va">cl</span>, X<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, fun<span class="op">=</span><span class="va">sim_rank</span>, fit_method<span class="op">=</span><span class="st">"vb"</span><span class="op">)</span></span>
<span><span class="va">ranks_vb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">ranks</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">ranks_vb</span>, file<span class="op">=</span><span class="st">"sbc_files/ranks_vb.rds"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="graphs-of-the-results">Graphs of the results<a class="anchor" aria-label="anchor" href="#graphs-of-the-results"></a>
</h2>
<p>Conventional histograms</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mcmc"</span>,<span class="st">"opt"</span>,<span class="st">"vb"</span><span class="op">)</span></span>
<span><span class="va">methods_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MCMC"</span>,<span class="st">"Optimisation"</span>,<span class="st">"Variational"</span><span class="op">)</span></span>
<span><span class="va">fnames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sbc_files/ranks_"</span>,<span class="va">methods</span>,<span class="st">".rds"</span><span class="op">)</span></span>
<span><span class="va">ranks</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="va">fnames</span>, <span class="va">methods_full</span>, </span>
<span>                         <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rank<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span>, </span>
<span>                                     method<span class="op">=</span><span class="va">.y</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.005</span>, <span class="fl">0.995</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1000</span>, prob<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">101</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ranks</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rank</span>,fill<span class="op">=</span><span class="va">method</span>,<span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"gray75"</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">bq</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ymax<span class="op">=</span><span class="va">bq</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, xmin<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, xmax<span class="op">=</span><span class="fl">101</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Rank"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Count out of N=1000"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Bin width 1"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">bq2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">qbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.005</span>, <span class="fl">0.995</span><span class="op">)</span>, size<span class="op">=</span><span class="fl">1000</span>, prob<span class="op">=</span><span class="fl">1</span><span class="op">/</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">ranks</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rank</span>,fill<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"gray75"</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">bq2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ymax<span class="op">=</span><span class="va">bq2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, xmin<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, xmax<span class="op">=</span><span class="fl">101</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Rank"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Bin width 2"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> </span>
<span>  </span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbc_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>QQ plots, which are easier to interpret than the histograms</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, by<span class="op">=</span><span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">rank_ecdf</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span><span class="va">fnames</span>, <span class="va">methods_full</span>, </span>
<span>                         <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, </span>
<span>                                     ecdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/ecdf.html" class="external-link">ecdf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, </span>
<span>                                     method <span class="op">=</span> <span class="va">.y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rank_ecdf</span><span class="op">$</span><span class="va">diff</span> <span class="op">&lt;-</span> <span class="va">rank_ecdf</span><span class="op">$</span><span class="va">ecdf</span> <span class="op">-</span> <span class="va">rank_ecdf</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rank_ecdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">ecdf</span>, col<span class="op">=</span><span class="va">method</span>, group<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>intercept<span class="op">=</span><span class="fl">0</span>, slope<span class="op">=</span><span class="fl">1</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Theoretical quantiles of U(0,1)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Empirical quantiles"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">rank_ecdf</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="va">diff</span>, col<span class="op">=</span><span class="va">method</span>, group<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Empirical - theoretical quantiles"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Empirical quantiles"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="sbc_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The MCMC and variational Bayes methods seem to be accurate, since the
empirical distributions appear to be uniform, though there is evidence
of bias in the optimisation method.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
