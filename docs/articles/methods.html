<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Details of methods behind survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of methods behind survextrap">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Details of methods behind survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2022-06-30</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/methods.Rmd" class="external-link"><code>vignettes/methods.Rmd</code></a></small>
      <div class="d-none name"><code>methods.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="technical-details-of-the-model">Technical details of the model<a class="anchor" aria-label="anchor" href="#technical-details-of-the-model"></a>
</h2>
<p>See the <a href="../index.html">README</a> for the design principles
of the package, and the <a href="examples.html">examples vignette</a>
for examples of how to fit models.</p>
<p>It is work in progress, so it will be sketchy in some places.</p>
<div class="section level3">
<h3 id="m-splines">M-splines<a class="anchor" aria-label="anchor" href="#m-splines"></a>
</h3>
<p>The axis of time is split into a set of regions defined by
<em>knots</em>. In the figure below, the knots are located at the
integers from 0 to 10, as shown by the grid lines.</p>
<p>Each knot is associated with a <em>cubic polynomial function</em>
<span class="math inline">\(b_k(t)\)</span>, known as a <em>basis</em>
function. M-spline basis functions are defined to be positive.</p>
<p>Here there are 11 basis functions in the interior of the space. Each
basis function has a peak around the knot, and diminishes to zero on
either side. Two additional basis functions are used with peaks at the
boundaries of the space, so there are <span class="math inline">\(K=13\)</span> basis functions in total. See <a href="https://www.jstor.org/stable/2245395" class="external-link">Ramsay</a> for the exact
definitions of <span class="math inline">\(b_k(t)\)</span>.</p>
<p>The hazard <span class="math inline">\(h(t)\)</span> at time <span class="math inline">\(t\)</span> is defined by a <em>weighted sum</em>
of the basis functions:</p>
<p><span class="math display">\[h(t) = \eta \sum_k p_k
b_k(t)\]</span></p>
<p>with</p>
<ul>
<li><p>weights <span class="math inline">\(p_1,\ldots,p_K\)</span> that
sum to 1, <span class="math inline">\(\sum_k p_k = 1\)</span>, known as
the <em>basis coefficients</em>.</p></li>
<li><p>a <em>scale</em> parameter <span class="math inline">\(\eta\)</span> that describes the average level of
the hazard.</p></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">13</span>, <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_uniform_weights.html">mspline_uniform_weights</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span>, bknots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">13</span>, scale<span class="op">=</span><span class="fl">10</span>, p <span class="op">=</span> <span class="va">p_const</span>, plot<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">hazard</span> </span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">13</span>, scale<span class="op">=</span><span class="fl">10</span>, p <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"h(t): weights `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): weights `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">3</span><span class="op">)</span> </span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="using-m-splines-to-represent-particular-hazard-shapes">Using M-splines to represent particular hazard shapes<a class="anchor" aria-label="anchor" href="#using-m-splines-to-represent-particular-hazard-shapes"></a>
</h3>
<p>The weights <span class="math inline">\(p_k\)</span> define how the
hazard changes through time. If knots are equally spaced, then <span class="math inline">\(p_k\)</span> are nearly proportional to the hazard
in the <span class="math inline">\(k\)</span>th region, so that if all
<span class="math inline">\(p_k\)</span> are equal, then the hazard is
nearly constant (red line <code>p_equal</code> in the figure). It is not
exactly constant because of the influence of the regions at either end
of the space, whose polynomial functions have a skewed shape.</p>
<p>To produce a practically constant hazard, we can search numerically
for the <span class="math inline">\(p_k\)</span> which minimise the
variance of a selection of points <span class="math inline">\(t\)</span>
that span the area that we want to model. This search can be done
automatically in the package (red line <code>p_const</code> in the
figure).</p>
<p><strong>Extrapolation?</strong> To fully specify a parametric
time-to-event model, we have to define the hazard for times greater than
the time <span class="math inline">\(t_{K}\)</span> of the highest knot,
which is 10 in the example.</p>
<p>The model in <code>survextrap</code> simply assumes that the hazard
for <span class="math inline">\(t &gt; t_{K}\)</span> is constant, the
same as the hazard at <span class="math inline">\(t_{K}\)</span>.</p>
<p>Therefore, if you want to estimate survival over a period where you
think the hazard might not be constant, then you should make sure that
the highest spline knot <span class="math inline">\(t_K\)</span> is
after the end of this period.</p>
<p>(<em>Sidenote</em>. Another way to define the hazard beyond the last
knot would be to extrapolate the final basis polynomials, but this is
not implemented. Although it would lead to a more smoothly extrapolated
hazard, it would be driven by data just before the boundary, and would
be making opaque assumptions about how the hazard changes after the
boundary. The idea behind the package is to make all assumptions
explicit as data or mechanisms. Perhaps a better approach would be to
make the function smooth at the final knot but still constant after
then, somehow).</p>
<p>Examples of doing this with different kinds of data and knowledge are
given in <code><a href="../articles/examples.html">vignette("examples")</a></code>.</p>
<p>Another arbitrary example of an M-spline curve:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">5</span><span class="op">)</span>, bknots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>     p<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span>, tmax<span class="op">=</span><span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level5">
<h5 id="why-not-other-kinds-of-spline">Why not other kinds of spline?<a class="anchor" aria-label="anchor" href="#why-not-other-kinds-of-spline"></a>
</h5>
<ul>
<li><p>The Royston/Parmar model (e.g. in flexsurv) uses a natural cubic
spline for the log cumulative hazard function. A cumulative hazard is
defined to be a non-decreasing function, but the spline is not
constrained. The constraint is handled during fitting the model - spline
coefficients which imply non-increasing cumulative hazard functions are
rejected. This is inefficient.</p></li>
<li><p>We could also have placed an unrestricted spline on the log
hazard. The disadvantage with this is that the cumulative hazard
(required to obtain the likelihood for censored data) then has to be
evaluated by numerical integration, which is slow.</p></li>
</ul>
<p>The advantage of putting an M-spline on the hazard is that it
respects the constraint that a hazard has to be non-negative, while it
can be integrated analytically to produce the cumulative hazard.</p>
<p>A remaining disadvantage is that they still rely on a choice of knot
locations. We hope to show that this does not matter much. Suggestions
of alternative model families are welcome. Gaussian processes, perhaps?
Though these are conceptually much harder.</p>
</div>
</div>
<div class="section level3">
<h3 id="bayesian-model-specification">Bayesian model specification<a class="anchor" aria-label="anchor" href="#bayesian-model-specification"></a>
</h3>
<p>The <em>parameters</em> of the model, <span class="math inline">\(p_k\)</span> and <span class="math inline">\(\eta\)</span>, are estimated from data using
Bayesian inference.</p>
<p>The <em>flexibility</em> of the fitted model is determined by two
things.</p>
<ol style="list-style-type: lower-alpha">
<li><p>The number <span class="math inline">\(K\)</span> and choice of
knots. This determines the <em>maximum potential flexibility</em> of the
hazard function.</p></li>
<li><p>The <em>prior distribution</em> on the basis coefficients <span class="math inline">\(p_k\)</span>. This plays the role of
<em>smoothing</em> the fitted hazard function.</p></li>
</ol>
<p>The default approach taken by <code>survextrap</code> is to choose a
large number of knots <span class="math inline">\(K\)</span>, intended
to accommodate all reasonable situations, and then <em>estimate</em> the
extent of smoothing needed from the data.</p>
<ul>
<li><p>With <em>more data</em>, the fitted curve is as flexible as
necessary to represent the data.</p></li>
<li><p>With <em>less data</em>, the fit is influenced more by the
prior.</p></li>
</ul>
<p>This is a smoother, Bayesian analogue of the common approach to
spline model selection based on choosing <span class="math inline">\(K\)</span> to give the model with the lowest AIC.
It also similar in principle to the “penalised likelihood” methods
implemented in e.g. the <code>mgcv</code> and <code>rstpm2</code>
packages.</p>
</div>
<div class="section level3">
<h3 id="prior-distribution-for-the-hazard-curve">Prior distribution for the hazard curve<a class="anchor" aria-label="anchor" href="#prior-distribution-for-the-hazard-curve"></a>
</h3>
<p>A log-normal prior is used for the scale <span class="math inline">\(\eta\)</span>. Currently this is set to the log
crude event rate plus normal(0, 20) (inspired by <a href="https://arxiv.org/pdf/2002.09633.pdf" class="external-link">rstanarm</a>) - but this
will be customisable in a future version.</p>
<p>A multinomial logistic distribution defines the prior for the
coefficients <span class="math inline">\(p_k\)</span> that define the
mass of the hazard in each region: <span class="math inline">\(log(p_k /
p_1) = \beta_k\)</span>, with <span class="math inline">\(\beta_1=0\)</span> and <span class="math inline">\(\beta_k \sim Logistic(\mu_k, \sigma)\)</span> for
<span class="math inline">\(k = 2, \ldots, K\)</span>. This prior is
defined by:</p>
<ol style="list-style-type: lower-alpha">
<li><p><strong>Prior mean</strong>: <span class="math inline">\(\boldsymbol{\mu} = (\mu_2,\ldots,\mu_K)\)</span>.
By default, this is determined from the special set of <span class="math inline">\(p_k\)</span> that result in a <em>constant
hazard</em> <span class="math inline">\(h(t)\)</span>, REF graph
above.</p></li>
<li>
<p><strong>Prior variability</strong>: <span class="math inline">\(\sigma\)</span> controls the smoothness of the
fitted hazard curve.</p>
<ul>
<li><p>If <span class="math inline">\(\sigma=0\)</span>, then we are
certain that the hazard function is the one defined by <span class="math inline">\(\boldsymbol{\mu}\)</span>.</p></li>
<li><p>Values of <span class="math inline">\(\sigma\)</span> around 1
favour wiggly curves, such that the fitted hazard curve is driven mainly
by the the observed data.</p></li>
<li><p>For <em>very</em> high values of <span class="math inline">\(\sigma\)</span>, the hazard is dominated by a
random one of the <span class="math inline">\(K\)</span> basis
functions, which will not typically be useful in practice.</p></li>
</ul>
</li>
</ol>
<p>(<em>Sidenote</em>. This is similar to the Dirichlet distribution for
the <span class="math inline">\(p_k\)</span>, but is slightly better
behaved for estimation. While the interpretation of <span class="math inline">\(\sigma\)</span> is not completely intuitive, we
hope to show empirically that this prior works usefully well in
practice)</p>
<p>The plots below show samples from the prior distribution for the
hazard functions implied by two choices of the joint distribution for
<span class="math inline">\(\eta\)</span> and <span class="math inline">\(p\)</span>. In both, <span class="math inline">\(\eta\)</span> is log normal(0,1), which supports
hazard rates between about 0.1 and 7, and the prior mean for <span class="math inline">\(p\)</span> is the special set that is centred
around a constant hazard. The two samples differ by the choice of prior
variability. <span class="math inline">\(\sigma=0.05\)</span> is a
strong prior that forces the hazard to be nearly uniform, while <span class="math inline">\(\sigma=1\)</span> allows a wide range of wiggly
shapes.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span>; <span class="va">bknots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">p_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_uniform_weights.html">mspline_uniform_weights</a></span><span class="op">(</span><span class="va">knots</span>, <span class="va">bknots</span><span class="op">)</span></span>
<span><span class="va">prior_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">p_mean</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">/</span> <span class="va">p_mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#prior_mean &lt;- rep(1, length(knots) + 4)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_mspline_priorpred.html">plot_mspline_priorpred</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, bknots<span class="op">=</span><span class="va">bknots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bknots</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>                       prior_mean<span class="op">=</span><span class="va">prior_mean</span>, prior_sd<span class="op">=</span><span class="fl">0.05</span>, scale_sd<span class="op">=</span><span class="fl">1</span>, nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">==</span><span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_mspline_priorpred.html">plot_mspline_priorpred</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, bknots<span class="op">=</span><span class="va">bknots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bknots</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span>, </span>
<span>                       prior_mean<span class="op">=</span><span class="va">prior_mean</span>, prior_sd<span class="op">=</span><span class="fl">1</span>, scale_sd<span class="op">=</span><span class="fl">1</span>, nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Removed 999 row(s) containing missing values (geom_path).</span></span></code></pre>
<p><img src="methods_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>By default, the package estimates <span class="math inline">\(\sigma\)</span> as part of the full Bayesian model
(with a gamma(2,1) prior), so that uncertainty about the level of
smoothness is accounted for.</p>
<p>If sampling is poor, then this alternative procedure might work - fit
the model in two steps (“empirical Bayes”):</p>
<ol style="list-style-type: decimal">
<li><p>A “training” model fit is perfomed, where a prior is placed on
<span class="math inline">\(\sigma\)</span>, and the maximum a
posteriori estimate <span class="math inline">\(\hat\sigma\)</span> of
<span class="math inline">\(\sigma\)</span> is determined.</p></li>
<li><p>A “final” model is then fitted, in which <span class="math inline">\(\sigma\)</span> is fixed to <span class="math inline">\(\hat\sigma\)</span>, giving the “optimal” amount
of smoothness for the hazard <span class="math inline">\(h(t)\)</span>.</p></li>
</ol>
<p>Either way, these procedures still need to be tested empirically to
see whether they gives sensible results. It seems to under-smooth in
some cases. Though it may not matter if the hazard function is
under-smoothed, if the purpose of the model is to estimate a quantity
that is an average over time (e.g. mean survival).</p>
<p>A sensible route to resolving these uncertainties might be use
cross-validation to assess and choose between model specifications,
though this hasn’t been implemented yet (is a “leave-one-out” approach
OK with censored data?). Note that this would only assess short-term
fit, using the same principle as AIC.</p>
</div>
<div class="section level3">
<h3 id="choice-of-knots-when-modelling-data">Choice of knots when modelling data<a class="anchor" aria-label="anchor" href="#choice-of-knots-when-modelling-data"></a>
</h3>
<p>By default, internal knots are placed at the quantiles of the vector
comprising the uncensored survival times in the individual level data
and the distinct follow-up times in the external data. (Smarter
suggestions are welcome for this).</p>
<p>6 internal knots are used, which (with cubic polynomials) leads to
<span class="math inline">\(K=10\)</span> basis functions [check this
notation] and parameters</p>
<p>Users can override this default however, and place knots at any
position.</p>
<p>By default, the lower boundary knot is set to 0. The upper boundary
knot is set to the highest follow-up time in the data. This default
should be overridden if you want to extrapolate, and you think the
hazard might change.</p>
<p>Currently, the number of knots does not depend on the absolute amount
of data - should it? With small datasets, there will be lots of knots
and very few data points between them - and we will be relying more
strongly on the prior to do the smoothing. If we implemented
cross-validation, we could assess whether this matters.</p>
<p>With external data, we want a choice of knots outside the data which
we can defend as allowing a reasonable range of shapes for the hazard
function, prior to observing the data.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.5.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
